name: Update GitOps versions

on:
  workflow_call:
    inputs:
      service_key:
        type: string
        required: true
        description: 'Key in versions.yaml, e.g. auth-service'
      image_tag:
        type: string
        required: true
        description: 'Image tag value to set, e.g. 2.2.32'
      gitops_repo:
        type: string
        required: false
        default: 'PilotDataPlatform/pilot-hdc-platform-gitops'
        description: 'GitOps repository (org/repo)'
      versions_file:
        type: string
        required: false
        default: 'clusters/dev/versions.yaml'
        description: 'Path to versions.yaml within the gitops repo'
    secrets:
      HDC_CSCS_INFRA_READ_WRITE_TOKEN:
        required: true
        description: 'PAT with write access to the gitops repo'

jobs:
  update-versions:
    name: Bump ${{ inputs.service_key }} to ${{ inputs.image_tag }}
    runs-on: hdc-dev-runners-public
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout gitops repo
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.gitops_repo }}
          token: ${{ secrets.HDC_CSCS_INFRA_READ_WRITE_TOKEN }}
          ref: main

      - name: Validate service key exists
        env:
          SERVICE_KEY: ${{ inputs.service_key }}
        run: |
          if ! yq -e '.[env(SERVICE_KEY)]' "${{ inputs.versions_file }}" > /dev/null 2>&1; then
            echo "::error::service_key '$SERVICE_KEY' not found in ${{ inputs.versions_file }}"
            exit 1
          fi

      - name: Update image tag
        env:
          SERVICE_KEY: ${{ inputs.service_key }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          yq -i '.[env(SERVICE_KEY)].image.tag = env(IMAGE_TAG)' "${{ inputs.versions_file }}"

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to versions.yaml â€” tag already up to date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            git diff
          fi

      - name: Commit and push
        if: steps.diff.outputs.changed == 'true'
        env:
          SERVICE_KEY: ${{ inputs.service_key }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@users.noreply.github.com"
          git commit -am "ci: bump $SERVICE_KEY image tag to $IMAGE_TAG"
          # Retry with rebase to handle concurrent pushes from other services
          PUSHED=false
          for i in 1 2 3; do
            if git push origin main; then
              PUSHED=true
              break
            fi
            echo "Push failed (attempt $i/3), rebasing and retrying..."
            git pull --rebase origin main
          done
          if [ "$PUSHED" != "true" ]; then
            echo "::error::Failed to push after 3 attempts"
            exit 1
          fi
